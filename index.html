<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dolphin规则编辑器</title>
    <style>
        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.5;
        }

        /* 应用容器样式 */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            min-height: 100vh;
        }

        /* 头部样式 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e8e8e8;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #262626;
        }

        /* 头部操作按钮 */
        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background-color: #fff;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 60px;
        }

        .btn:hover {
            border-color: #1890ff;
            color: #1890ff;
        }

        .btn-primary {
            background-color: #1890ff;
            border-color: #1890ff;
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #40a9ff;
            border-color: #40a9ff;
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* 规则编辑器表格布局 */
        .rule-editor {
            margin-bottom: 30px;
            background-color: #fafafa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            padding: 20px 20px 10px;
            color: #333;
        }

        /* 规则决策表格样式 */
        .rule-decision-table {
            width: 100%;
            border-collapse: collapse;
        }

        .rule-decision-table th,
        .rule-decision-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        /* 第三列内容居中 */
        .rule-decision-table td:nth-child(3) {
            text-align: center;
        }

        .rule-decision-table th {
            background-color: #f0f0f0;
            font-weight: 600;
            color: #333;
        }

        /* 规则项样式 */
        .rule-item {
            background-color: white;
        }

        /* 规则名称输入 */
        .rule-name input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }

        /* 规则名称容器 */
        .rule-name-container {
            margin-bottom: 8px;
        }

        /* 规则表达式输入 */
        .rule-expression {
            width: 100%;
            display: block;
        }

        .rule-expression {
            width: calc(100% - 24px);
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            min-height: 60px;
            resize: vertical;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* 规则操作按钮 */
        .rule-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* 拖放样式 */
        .rule-item.dragging {
            opacity: 0.5;
            background-color: #e6f7ff;
        }

        .rule-item.dragover {
            background-color: #f0f5ff;
            border-bottom: 2px solid #1890ff;
        }

        /* 决策列表样式 */
        .decision-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 决策项样式 */
        .decision-item {
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        /* 决策头部样式 */
        .decision-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .decision-type {
            font-weight: 500;
            color: #333;
        }

        /* 动作列表样式 */
        .action-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* 动作行样式 */
        .action-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .action-select, .action-input {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }

        .action-select:focus, .action-input:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .action-select {
            min-width: 120px;
        }

        .action-input {
            flex: 1;
            min-width: 150px;
        }

        /* 测试部分样式 */
        .test-section {
            margin-top: 30px;
            background-color: #fafafa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .test-inputs h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        /* 测试数据网格布局 */
        .test-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .test-data-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .test-data-item label {
            font-size: 14px;
            color: #666;
        }

        .test-data-item input {
            padding: 6px 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }

        .test-data-item input:focus {
            outline: none;
            border-color: #1890ff;
        }

        /* 测试输入文本区域 */
        .test-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 100px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        /* 测试结果样式 */
        .test-results {
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            margin-top: 15px;
        }

        /* 测试结果详情样式 */
        .test-results-details {
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            margin-top: 15px;
        }

        .result-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .result-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: #333;
            margin-right: 10px;
        }

        .result-value {
            font-family: 'Courier New', monospace;
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* 结果摘要 */
        .result-summary {
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 4px;
            color: #52c41a;
        }

        /* 结果轨迹 */
        .result-trace {
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: #fafafa;
            border-radius: 4px;
        }

        .result-trace h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #666;
        }

        .result-trace ul {
            list-style: none;
            padding-left: 0;
        }

        .result-trace li {
            padding: 6px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 13px;
        }

        /* 轨迹通过和失败样式 */
        .trace-passed {
            background-color: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .trace-failed {
            background-color: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState } = React;

        const App = () => {
            // 规则数据状态 - 每个规则包含自己的决策
            const [rules, setRules] = useState([
                {
                    id: 1, 
                    name: '规则1', 
                    expression: 'age >= 18', 
                    action: '通过', 
                    decisions: [
                        {
                            id: 1,
                            name: '规则1决策',
                            actions: [
                                { type: 'SET', key: 'result', value: 'true', target: 'ML_DECISION' }
                            ]
                        }
                    ]
                },
                {
                    id: 2, 
                    name: '规则2', 
                    expression: 'age <= 18', 
                    action: '拒绝', 
                    decisions: [
                        {
                            id: 2,
                            name: '规则2决策',
                            actions: [
                                { type: 'SET', key: 'result', value: 'false', target: 'ML_DECISION' },
                                { type: 'INCR', key: 'key', value: 'Value' }
                            ]
                        }
                    ]
                }
            ]);

            // 拖拽功能状态
            const [draggingId, setDraggingId] = useState(null);
            const [dragOverId, setDragOverId] = useState(null);
            
            // 测试数据状态
            const [testInput, setTestInput] = useState('{ "age": 28 }');
            const [testResult, setTestResult] = useState(null);
            const [showTestResult, setShowTestResult] = useState(false);
            const [resultTrace, setResultTrace] = useState([]);

            // 拖拽事件处理函数
            const handleDragStart = (id) => {
                setDraggingId(id);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
            };

            const handleDragEnter = (id) => {
                if (id !== draggingId) {
                    setDragOverId(id);
                }
            };

            const handleDragLeave = () => {
                setDragOverId(null);
            };

            const handleDrop = (dropId) => {
                if (draggingId === dropId) return;

                const draggingIndex = rules.findIndex(r => r.id === draggingId);
                const dropIndex = rules.findIndex(r => r.id === dropId);

                const newRules = [...rules];
                const [draggedRule] = newRules.splice(draggingIndex, 1);
                newRules.splice(dropIndex, 0, draggedRule);

                setRules(newRules);
                setDraggingId(null);
                setDragOverId(null);
            };

            // 更新规则名称
            const updateRuleName = (id, name) => {
                setRules(rules.map(rule => rule.id === id ? { ...rule, name } : rule));
            };

            // 更新规则表达式
            const updateRuleExpression = (id, expression) => {
                setRules(rules.map(rule => rule.id === id ? { ...rule, expression } : rule));
            };

            // 添加新规则
            const addNewRule = () => {
                const newId = Math.max(...rules.map(r => r.id)) + 1;
                setRules([...rules, { 
                    id: newId, 
                    expression: '', 
                    name: `新规则名： ${newId}`,
                    description: '',
                    action: '',
                    decisions: [
                        {
                            id: newId,
                            name: `规则${newId}决策`,
                            actions: [
                                { type: 'SET', key: '', value: '', target: 'ML_DECISION' }
                            ]
                        }
                    ]
                }]);
            };

            // 删除规则
            const handleDeleteRule = (id) => {
                if (rules.length <= 1) {
                    alert('至少需要保留一条规则');
                    return;
                }
                setRules(rules.filter(rule => rule.id !== id));
            };

            // 复制规则
            const handleCopyRule = (id) => {
                const ruleToCopy = rules.find(rule => rule.id === id);
                if (!ruleToCopy) return;
                
                const newId = Math.max(...rules.map(r => r.id)) + 1;
                const newRule = {
                    ...ruleToCopy,
                    id: newId,
                    name: `${ruleToCopy.name} (复制)`,
                    decisions: ruleToCopy.decisions.map(decision => ({
                        ...decision,
                        id: newId,
                        name: `${decision.name} (复制)`
                    }))
                };
                
                setRules([...rules, newRule]);
            };

            // 处理动作变更
            const handleActionChange = (ruleId, decisionId, actionIndex, field, value) => {
                setRules(rules.map(rule => {
                    if (rule.id === ruleId) {
                        const updatedDecisions = rule.decisions.map(decision => {
                            if (decision.id === decisionId) {
                                const updatedActions = [...decision.actions];
                                updatedActions[actionIndex] = { ...updatedActions[actionIndex], [field]: value };
                                return { ...decision, actions: updatedActions };
                            }
                            return decision;
                        });
                        return { ...rule, decisions: updatedDecisions };
                    }
                    return rule;
                }));
            };

            // 添加新的决策动作
            const addNewDecisionAction = (ruleId, decisionId) => {
                setRules(rules.map(rule => {
                    if (rule.id === ruleId) {
                        const updatedDecisions = rule.decisions.map(decision => {
                            if (decision.id === decisionId) {
                                return { 
                                    ...decision, 
                                    actions: [...decision.actions, { type: 'SET', key: '', value: '', target: 'ML_DECISION' }]
                                };
                            }
                            return decision;
                        });
                        return { ...rule, decisions: updatedDecisions };
                    }
                    return rule;
                }));
            };

            // 删除决策动作
            const deleteDecisionAction = (ruleId, decisionId, actionIndex) => {
                setRules(rules.map(rule => {
                    if (rule.id === ruleId) {
                        const updatedDecisions = rule.decisions.map(decision => {
                            if (decision.id === decisionId) {
                                if (decision.actions.length <= 1) {
                                    alert('至少需要保留一个动作');
                                    return decision;
                                }
                                const updatedActions = [...decision.actions];
                                updatedActions.splice(actionIndex, 1);
                                return { ...decision, actions: updatedActions };
                            }
                            return decision;
                        });
                        return { ...rule, decisions: updatedDecisions };
                    }
                    return rule;
                }));
            };

            // 添加新的决策项
            const addNewDecision = (ruleId) => {
                setRules(rules.map(rule => {
                    if (rule.id === ruleId) {
                        const newDecisionId = Math.max(...rule.decisions.map(d => d.id), 0) + 1;
                        return { 
                            ...rule, 
                            decisions: [...rule.decisions, {
                                id: newDecisionId,
                                name: `决策${newDecisionId}`,
                                actions: [{ type: 'SET', key: '', value: '', target: 'ML_DECISION' }]
                            }]
                        };
                    }
                    return rule;
                }));
            };

            // 删除决策项
            const deleteDecision = (ruleId, decisionId) => {
                setRules(rules.map(rule => {
                    if (rule.id === ruleId) {
                        // 确保至少保留一个决策项
                        if (rule.decisions.length > 1) {
                            return { 
                                ...rule, 
                                decisions: rule.decisions.filter(d => d.id !== decisionId)
                            };
                        }
                    }
                    return rule;
                }));
            };

            // 处理测试输入变更
            const handleTestInputChange = (e) => {
                setTestInput(e.target.value);
            };

            // 运行测试
            const runTest = () => {
                try {
                    const input = JSON.parse(testInput);
                    const results = rules.map(rule => {
                        try {
                            // 使用eval执行规则表达式，实际生产环境应使用更安全的方式
                            const age = input.age;
                            const balance = input.balance || 0;
                            const score = input.score || 0;
                            const hasBadRecord = input.hasBadRecord || false;
                            const level = input.level || '';
                            const points = input.points || 0;
                            
                            // 处理level字符串比较
                            const processedExpression = rule.expression.replace(/level\s*==\s*([A-Z]+)/g, (match, p1) => `level == '${p1}'`);
                            const isMatch = eval(processedExpression);
                            
                            return { 
                                ruleName: rule.name, 
                                expression: rule.expression, 
                                matched: isMatch,
                                decision: isMatch ? rule.decisions[0].actions : []
                            };
                        } catch (error) {
                            return { 
                                ruleName: rule.name, 
                                expression: rule.expression, 
                                matched: false,
                                error: error.message
                            };
                        }
                    });
                    
                    // 生成测试轨迹
                    const trace = results.map(result => ({
                        ruleName: result.ruleName,
                        expression: result.expression,
                        passed: result.matched,
                        result: result.matched ? '通过' : result.error ? `错误: ${result.error}` : '未通过'
                    }));
                    
                    // 找到第一个匹配的规则结果
                    const firstMatch = results.find(result => result.matched);
                    const finalResult = firstMatch ? '规则命中' : '未命中任何规则';
                    
                    setTestResult({ results, finalResult });
                    setResultTrace(trace);
                    setShowTestResult(true);
                } catch (error) {
                    alert('输入JSON格式错误: ' + error.message);
                }
            };

            return (
                <div className="app-container">
                    <div className="header">
                        <h1>规则组：规则组1</h1>
                        <div className="header-actions">
                            <button className="btn btn-secondary">取消</button>
                            <button className="btn btn-secondary">确定</button>
                            <button className="btn btn-primary">保存并启用</button>
                        </div>
                    </div>

                    <div className="rule-editor">
                        <div className="section-title">规则与决策</div>
                        <table className="rule-decision-table">
                            <thead>
                                <tr>
                                    <th style={{ width: '5%' }}>序号</th>
                                    <th style={{ width: '30%' }}>规则列</th>
                                    <th style={{ width: '45%' }}>决策列</th>
                                    <th style={{ width: '20%' }}>操作列</th>
                                </tr>
                            </thead>
                            <tbody>
                                {rules.map((rule, index) => (
                                    <tr 
                                        key={rule.id} 
                                        className={`rule-item ${draggingId === rule.id ? 'dragging' : dragOverId === rule.id ? 'dragover' : ''}`}
                                        draggable="true"
                                        onDragStart={() => handleDragStart(rule.id)}
                                        onDragOver={handleDragOver}
                                        onDragEnter={() => handleDragEnter(rule.id)}
                                        onDragLeave={handleDragLeave}
                                        onDrop={() => handleDrop(rule.id)}
                                    >
                                        <td style="text-align: center;">{index + 1}</td>
                                        <td>
                                            <div className="rule-name">
                                                <input
                                                    type="text"
                                                    value={rule.name}
                                                    onChange={(e) => updateRuleName(rule.id, e.target.value)}
                                                    placeholder="规则名称"
                                                />
                                            </div>
                                            <div className="rule-expression">
                                                <input
                                                    type="text"
                                                    value={rule.expression}
                                                    onChange={(e) => updateRuleExpression(rule.id, e.target.value)}
                                                    placeholder="输入规则表达式，例如：age >= 18"
                                                />
                                            </div>
                                        </td>
                                        <td>
                                            {rule.decisions.map((decision) => (
                                                <div key={decision.id} className="decision-item">
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                                                        <h4 style={{ margin: 0 }}>{decision.name}</h4>
                                                        <button 
                                                            className="btn btn-small btn-secondary"
                                                            onClick={() => deleteDecision(rule.id, decision.id)}
                                                            title="删除决策项"
                                                        >
                                                            删除决策
                                                        </button>
                                                    </div>
                                                    <div className="action-list">
                                                        {decision.actions.map((action, actionIndex) => (
                                                            <div key={actionIndex} className="action-row">
                                                                <select
                                                                    className="action-select"
                                                                    value={action.target}
                                                                    onChange={(e) => handleActionChange(rule.id, decision.id, actionIndex, 'target', e.target.value)}
                                                                >
                                                                    <option value="">请选择</option>
                                                                </select>
                                                                <select
                                                                    className="action-select"
                                                                    value={action.type}
                                                                    onChange={(e) => handleActionChange(rule.id, decision.id, actionIndex, 'type', e.target.value)}
                                                                >
                                                                    <option value="SET">SET</option>
                                                                    <option value="INCR">INCR</option>
                                                                </select>
                                                                <input
                                                                    type="text"
                                                                    className="action-input"
                                                                    value={action.key}
                                                                    onChange={(e) => handleActionChange(rule.id, decision.id, actionIndex, 'key', e.target.value)}
                                                                    placeholder="key"
                                                                />
                                                                <input
                                                                    type="text"
                                                                    className="action-input"
                                                                    value={action.value}
                                                                    onChange={(e) => handleActionChange(rule.id, decision.id, actionIndex, 'value', e.target.value)}
                                                                    placeholder="value"
                                                                />
                                                                <button className="btn btn-small btn-secondary" onClick={() => deleteDecisionAction(rule.id, decision.id, actionIndex)}>删除动作</button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <button 
                                                        className="btn btn-small btn-secondary"
                                                        onClick={() => addNewDecisionAction(rule.id, decision.id)}
                                                        style={{ marginTop: '8px' }}
                                                    >
                                                        + 添加决策
                                                    </button>
                                                </div>
                                            ))}
                                        </td>
                                        <td>
                                            <div className="rule-actions">
                                                <button className="btn btn-small btn-secondary" onClick={() => handleCopyRule(rule.id)}>复制行</button>
                                                <button className="btn btn-small btn-secondary" onClick={() => handleDeleteRule(rule.id)}>删除行</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        <div style={{ padding: '20px' }}>
                            <button className="btn btn-secondary" onClick={addNewRule}>
                                + 添加规则
                            </button>
                        </div>
                    </div>

                    <div className="test-section">
                        <div className="section-title">测试</div>
                        <textarea
                            className="test-input"
                            value={testInput}
                            onChange={handleTestInputChange}
                            placeholder="输入测试数据，例如：{ &quot;age&quot;: 28 }"
                        ></textarea>
                        <button className="btn btn-primary" onClick={runTest}>
                            运行测试
                        </button>
                        
                        {showTestResult && testResult && (
                            <div className="test-results">
                                <h3>测试结果</h3>
                                <div className="result-summary">
                                    <strong>最终结果:</strong> {testResult.finalResult}
                                </div>
                                <div className="result-trace">
                                    <h4>规则执行轨迹:</h4>
                                    <ul>
                                        {resultTrace.map((trace, index) => (
                                            <li key={index} className={trace.passed ? 'trace-passed' : 'trace-failed'}>
                                                <strong>{trace.ruleName}:</strong> {trace.expression} - {trace.result}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                                <div className="test-results-details">
                                    {testResult.results.map((result, index) => (
                                        <div key={index} className="result-item">
                                            <div>
                                                <span className="result-label">规则:</span>
                                                <span className="result-value">{result.ruleName}</span>
                                            </div>
                                            <div>
                                                <span className="result-label">表达式:</span>
                                                <span className="result-value">{result.expression}</span>
                                            </div>
                                            <div>
                                                <span className="result-label">匹配结果:</span>
                                                <span className="result-value">{result.matched ? 'true' : 'false'}</span>
                                            </div>
                                            {result.error && (
                                                <div>
                                                    <span className="result-label">错误:</span>
                                                    <span className="result-value">{result.error}</span>
                                                </div>
                                            )}
                                            {result.decision && (
                                                <div>
                                                    <span className="result-label">执行决策:</span>
                                                    <span className="result-value">
                                                        {JSON.stringify(result.decision, null, 2)}
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>,
            document.getElementById('root')
        );
    </script>
</body>
</html>